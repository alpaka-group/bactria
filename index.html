<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>bactria: bactria - Broadly Applicable C++ Tracing and Instrumentation API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">bactria
   &#160;<span id="projectnumber">0.0.1</span>
   </div>
   <div id="projectbrief">The bactria library is a header-only C++14 library for profiling and tracing.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">bactria - Broadly Applicable C++ Tracing and Instrumentation API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://isocpp.org/"><img src="https://img.shields.io/badge/-C++14-5E97D0?logo=C%2B%2B&amp;logoColor=white&amp;style=for-the-badge" alt="Language" class="inline"/></a> <a href="https://github.com/alpaka-group/alpaka"><img src="https://img.shields.io/badge/platform-linux%20|%20windows%20|%20mac-lightgrey?style=for-the-badge" alt="Platforms" class="inline"/></a> <a href="https://www.mozilla.org/en-US/MPL/2.0/"><img src="https://img.shields.io/github/license/alpaka-group/bactria?color=003399&amp;style=for-the-badge" alt="License" class="inline"/></a></p>
<h1><a class="anchor" id="about"></a>
About this project</h1>
<h2><a class="anchor" id="about_intro"></a>
Introduction</h2>
<p>The <b>bactria</b> library is a header-only C++14 library for profiling and tracing. By annotating segments of your code with bactria's classes you can gather fine-grained information about your application's performance without introducing runtime overhead in other program parts.</p>
<p>bactria itself is platform-independent and provides a unified modern C++ API to the user. The profiling and/or tracing information are collected by its various plugins:</p>
<ul>
<li>JSON: Supported on all platforms. Used for saving user-defined metrics to disk.</li>
<li>stdout: Supported on all platforms. Used for tracing events and time spans and printing them to stdout.</li>
<li>Score-P: Supported on Linux. Used for collecting various metrics (such as hardware counters) and saving them to disk for later analysis.</li>
<li>NVTX: Supported on all platforms. Used for tracing events and time spans and visualizing them on NVIDIA's visual profilers.</li>
<li>rocTX: Supported on Linux. Used for tracing events and time spans and visualizing them on Chrome's <code>about:tracing</code> tool (used by AMD's ROCm).</li>
</ul>
<h2><a class="anchor" id="about_differences"></a>
Differences to similar projects</h2>
<p>TODO: Fill this out!</p>
<h1><a class="anchor" id="getting_started"></a>
Getting started</h1>
<h2><a class="anchor" id="getting_started_pre"></a>
Prerequisites</h2>
<p>The user-facing API has no dependencies. However, most plugins require <a href="https://github.com/ToruNiina/toml11"><code>toml11</code></a> to be present and additionally introduce their platform-specific dependencies (such as Score-P, CUDA or ROCm).</p>
<p>bactria assumes that all builds happen out-of-source. The easiest way to achieve this is to create a <code>build</code> directory in bactria's top-level directory:</p>
<div class="fragment"><div class="line">git clone https://github.com/alpaka-group/bactria.git</div>
<div class="line">cd bactria</div>
<div class="line">mkdir build &amp;&amp; cd build</div>
</div><!-- fragment --><h2><a class="anchor" id="getting_started_conf"></a>
Configuration</h2>
<p>bactria uses CMake (&gt;=3.18) as a build system. On top of the common CMake build options (such as the build type) it supports the following configuration switches:</p>
<ul>
<li><code>bactria_BUILD_DOCUMENTATION</code> &ndash; Build the Doxygen documentation. Default: <code>ON</code>.</li>
<li><code>bactria_BUILD_EXAMPLES</code> &ndash; Build the examples (see the <code>examples</code> folder). Default: <code>ON</code>.</li>
<li><code>bactria_CUDA_PLUGINS</code> &ndash; Build the CUDA ecosystem plugins. Default: <code>OFF</code></li>
<li><code>bactria_JSON_PLUGINS</code> &ndash; Build the JSON-based plugins. Default: <code>ON</code><ul>
<li><code>bactria_SYSTEM_JSON</code> &ndash; Use your local installation of the nlohnmann-json library. If set to <code>OFF</code>, bactria will attempt to download the library to its build directory. Default: <code>ON</code>.</li>
</ul>
</li>
<li><code>bactria_ROCM_PLUGINS</code> &ndash; Build the ROCm ecosystem plugins. Default: <code>OFF</code>.</li>
<li><code>bactria_SCOREP_PLUGINS</code> &ndash; Build the Score-P plugins. Default: <code>OFF</code>.</li>
<li><code>bactria_STDOUT_PLUGINS</code> &ndash; Build the <code>stdout</code> plugins. Default: <code>ON</code>.<ul>
<li><code>bactria_SYSTEM_FMT</code> &ndash; Use your local installation of <code>{fmt}</code> if the <code>stdout</code> plugins are being built. If set to <code>OFF</code>, bactria will attempt to download the library to its build directory. Default: <code>ON</code>.</li>
</ul>
</li>
<li><code>bactria_SYSTEM_TOML11</code> &ndash; Use your local installation of toml11. If set to <code>OFF</code>, bactria will attempt to download the library to its build directory. Default: <code>ON</code>.</li>
</ul>
<p>The following example configures the build system for building the Doxygen documentation, the examples and the plugins for CUDA, JSON, Score-P and <code>stdout</code> in <code>Release</code> mode:</p>
<div class="fragment"><div class="line">cmake -DCMAKE_BUILD_TYPE=Release -Dbactria_CUDA_PLUGINS=ON -Dbactria_SCOREP_PLUGINS=ON ..</div>
</div><!-- fragment --><h2><a class="anchor" id="getting_started_build"></a>
Building</h2>
<p>If the previous step was successful all that is left to do is invoke the actual build command:</p>
<div class="fragment"><div class="line">cmake --build . --config Release -j[number of parallel jobs]</div>
</div><!-- fragment --><h1><a class="anchor" id="usage"></a>
Usage</h1>
<p>After a successful bactria build the contents of your <code>build</code> directory will look similar to this structure (Visual Studio and XCode builds may have another intermediate directory between <code>build</code> and the subdirectories here):</p>
<div class="fragment"><div class="line">build/</div>
<div class="line">|</div>
<div class="line">----.cmake/</div>
<div class="line">----CMakeFiles/</div>
<div class="line">----examples/</div>
<div class="line">----src/</div>
<div class="line">----[some files]/</div>
</div><!-- fragment --><p>You should be interested in the contents of <code>examples</code> and <code>src</code>. In the subdirectories of the <code>examples</code> folder you will find executables which already have built-in bactria support. In the subdirectories of the <code>src</code> folder you will find the plugins that were built according to your configuration:</p>
<div class="fragment"><div class="line">build/</div>
<div class="line">|</div>
<div class="line">----examples/</div>
<div class="line">|   |</div>
<div class="line">|   ----simpleLoop/</div>
<div class="line">|       |</div>
<div class="line">|       ----simpleLoop</div>
<div class="line">----src/</div>
<div class="line">    |</div>
<div class="line">    ----metrics/</div>
<div class="line">    |   |</div>
<div class="line">    |   ----scorep/</div>
<div class="line">    |       |</div>
<div class="line">    |       ----libbactria_metrics_scorep.so</div>
<div class="line">    ----ranges/</div>
<div class="line">    |   |</div>
<div class="line">    |   ----nvtx/</div>
<div class="line">    |   |   |</div>
<div class="line">    |   |   ----libbactria_ranges_nvtx.so</div>
<div class="line">    |   ----roctx/</div>
<div class="line">    |   ----stdout/</div>
<div class="line">    |       |</div>
<div class="line">    |       ----libbactria_ranges_stdout.so</div>
<div class="line">    ----reports/</div>
<div class="line">        |</div>
<div class="line">        ----json/</div>
<div class="line">            |</div>
<div class="line">            ----libbactria_reports_json.so</div>
</div><!-- fragment --><h2><a class="anchor" id="usage_plugins"></a>
Activating bactria plugins</h2>
<p>Switch to the directory with the built <code>simpleLoop</code> example:</p>
<div class="fragment"><div class="line">cd examples/simpleLoop</div>
</div><!-- fragment --><p>If you just execute the program without any further configuration you will notice that there are no additional output files produced. This is a design principle: If you do not want to use a certain aspect of bactria you do not have to! Internally, bactria will disable this functionality if no plugin was selected at runtime.</p>
<p>To enable bactria's plugins you have to set one (or more) of the following environment variables to the path of your desired plugin:</p>
<div class="fragment"><div class="line">export BACTRIA_METRICS_PLUGIN=/path/to/bactria/build/src/metrics/scorep/libbactria_metrics_scorep.so</div>
<div class="line">export BACTRIA_RANGES_PLUGIN=/path/to/bactria/build/src/ranges/nvtx/libbactria_ranges_nvtx.so</div>
<div class="line">export BACTRIA_REPORTS_PLUGIN=/path/to/bactria/build/src/reports/json/libbactria_reports_json.so</div>
<div class="line">./simpleLoop</div>
</div><!-- fragment --><p>After the program execution you should see some additional files in the directory that have not been present before. These are the files you can now load into your favourite analysis / profiling tools for further examination.</p>
<p>In the next sections we will explain the concepts behind <code>metrics</code>, <code>ranges</code> and <code>reports</code>.</p>
<h2><a class="anchor" id="usage_init"></a>
Initialization</h2>
<p>Before you can use bactria you have to initialize the library. This is done by creating a <code><a class="el" href="classbactria_1_1Context.html" title="The context.">Context</a></code> (once per process) and keeping it alive until you no longer require any functionality from bactria. The <code><a class="el" href="classbactria_1_1Context.html" title="The context.">Context</a></code> takes care of loading your selected plugin(s) into memory so you can make use of bactria's user API. The easiest way for managing a bactria <code><a class="el" href="classbactria_1_1Context.html" title="The context.">Context</a></code> is to create it at the beginning of <code>main</code> and keep it alive until the program stops:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="bactria_8hpp.html">bactria/bactria.hpp</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> main() -&gt; <span class="keywordtype">int</span></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">auto</span> ctx = <a class="code" href="classbactria_1_1Context.html">bactria::Context</a>{};</div>
<div class="line">        <span class="keyword">auto</span> ctx2 = ctx; <span class="comment">// This is okay; Context&#39;s internals are reference-counted</span></div>
<div class="line"> </div>
<div class="line">        foo();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// End of scope: ctx is destroyed and automatically shuts down bactria.</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">catch</span>(std::runtime_error <span class="keyword">const</span>&amp; err)</div>
<div class="line">    {</div>
<div class="line">        std::cerr &lt;&lt; err.what() &lt;&lt; std::endl;</div>
<div class="line">        <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that the context is wrapped into a <code>try</code>/<code>catch</code> block. Should any internal errors occur in bactria's user-facing parts a <code>std::runtime_error</code> will be thrown.</p>
<h2><a class="anchor" id="usage_ranges"></a>
Ranges</h2>
<p>bactria's ranges are a useful tool if you want to highlight / visualize certain events and time spans (= ranges) in your application code. This gives you a high-level view onto your program's behaviour and can help you with choosing the correct code segments to analyse in more detail.</p>
<ul>
<li><code>Event</code>s are single points in time and are simply triggered / <code>fire</code>d in the application code.</li>
<li><code>Range</code>s are time spans and are <code>start</code>ed and <code>stop</code>ped.</li>
<li>Both <code>Event</code>s and <code>Range</code>s can be assigned to a <code>Category</code>. Through the configuration file you can filter out all <code>Event</code>s and <code>Range</code>s part of a specific <code>Category</code>.</li>
</ul>
<p><code>Event</code>s and <code>Range</code>s can freely overlap / be nested in any way you feel necessary. This is how it looks like in code:</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> foo()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">using namespace </span>bactria::ranges;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// After construction func_range is immediately started.</span></div>
<div class="line">    <span class="keyword">auto</span> func_range = <a class="code" href="classbactria_1_1ranges_1_1Range.html">Range</a>{<span class="stringliteral">&quot;Function foo()&quot;</span>, <a class="code" href="group__html.html#gab5e46d92ed8fa06232f8067e60d72003">color::orange</a>};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Construct an event belonging to a category.</span></div>
<div class="line">    <span class="keyword">auto</span> cat_func_call = <a class="code" href="classbactria_1_1ranges_1_1Category.html">Category</a>{<span class="comment">/* id = */</span> 42, <span class="comment">/* name = */</span> <span class="stringliteral">&quot;function call&quot;</span>};</div>
<div class="line">    <span class="keyword">auto</span> call_event = <a class="code" href="classbactria_1_1ranges_1_1Event.html">Event</a>{<span class="stringliteral">&quot;Called bar()&quot;</span>, <a class="code" href="group__html.html#ga22ed4c4d205edff1c2d884569e256d50">color::green</a>, cat_func_call};</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Call bar once</span></div>
<div class="line">    bar();</div>
<div class="line">    call_event.fire(__FILE__, __LINE__, __func__);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Call bar again -- will show up as separate event on profiler</span></div>
<div class="line">    bar();</div>
<div class="line">    call_event.fire(__FILE__, __LINE__, __func__);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// For one-time events there is a convenience macro that removes the __FILE__ __LINE__ __func__ boilerplate</span></div>
<div class="line">    baz();    </div>
<div class="line">    <a class="code" href="group__bactria__ranges__user.html#ga092736a1459bddd49cc114adbd3dd681">bactria_Event</a>(<span class="stringliteral">&quot;Called baz()&quot;</span>, <a class="code" href="group__html.html#gaa43eae6ee7b94c6e890ace8891f4de71">color::blue</a>, cat_func_call);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Ranges can overlap</span></div>
<div class="line">    <span class="keyword">auto</span> r1 = <a class="code" href="classbactria_1_1ranges_1_1Range.html">Range</a>{<span class="stringliteral">&quot;Some range&quot;</span>, <a class="code" href="group__html.html#ga5075e3f73e853ecadcfef98933ff22bf">color::red</a>};</div>
<div class="line">    <span class="keyword">auto</span> r2 = <a class="code" href="classbactria_1_1ranges_1_1Range.html">Range</a>{<span class="stringliteral">&quot;Another range&quot;</span>, <a class="code" href="group__html.html#ga91c107cb4a7dd766d7c8d8e823253c71">color::cyan</a>};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Depending on condition one range is stopped now, the other when it leaves the scope.</span></div>
<div class="line">    <span class="keywordflow">if</span>(condition)</div>
<div class="line">        r1.stop();</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        r2.stop();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// End of scope: func_range and r1 or r2 are automatically stopped.</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>As you may have noticed we have supplied a color to the range / event constructor. Some plugins support custom colors to enhance the visualizer output (this depends on vendor APIs and is therefore not supported by all available plugins). You can either use one of bactria's numerous pre-defined colors (see <a class="el" href="Colors_8hpp.html" title="Color definitions.">Colors.hpp</a>) or supply your own color in ARGB format:</p>
<div class="fragment"><div class="line">constexpr <span class="keyword">auto</span> my_orange = 0xFFFFA500u;</div>
<div class="line">                         <span class="comment">//  ^^^^^^^^</span></div>
<div class="line">                         <span class="comment">//  AARRGGBB</span></div>
</div><!-- fragment --><h2><a class="anchor" id="usage_metrics"></a>
Metrics</h2>
<p>Once you have an idea of where your program spends most of its time you might want to optimize these portions. In order to find the major bottlenecks it is useful to look at certain metrics like hardware counters, a more detailed profiling, call stacks, and so on. Plugins implementing bactria's <code>metrics</code> functionality are built on top of various vendors' APIs dedicated to this purpose. By using bactria's <code>metrics</code> API you can make use of these APIs in a portable way.</p>
<p>In the <code>metrics</code> API the following classes are available:</p>
<ul>
<li><code>Sector</code>s are used as annotations in your code and enable the detailed collection of metrics by your ecosystem's performance tools.</li>
<li><code>Tag</code>s are a special kind of metadata that some plugins can make use of. By default, all <code>Sector</code>s are assigned the <code>Generic</code> tag. Some plugins understand additional information supplied by other <code>Tag</code>s, such as <code>Function</code>, <code>Loop</code>, <code>Body</code>, and so on, to provide you with more detailed results.</li>
<li><code>Phase</code>s are used to group <code>Sector</code>s (possibly in different scopes) into logical program phases. Some performance tools can make use of this information to provide you with an analysis of these logical segments.</li>
</ul>
<p>Both <code>Sector</code>s and <code>Phase</code>s follow a stack-based / LIFO-based programming approach. This means that they have to be correctly nested and cannot overlap freely (in contrast to the <code>ranges</code> API).</p>
<p>Example: </p><div class="fragment"><div class="line"><span class="keyword">auto</span> bar()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">using namespace </span>bactria::metrics;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Define logical phase and enter it immediately.</span></div>
<div class="line">    <span class="keyword">auto</span> p1 = <a class="code" href="classbactria_1_1metrics_1_1Phase.html">Phase</a>{<span class="stringliteral">&quot;first_bar_half&quot;</span>, __FILE__, __LINE__, __func__};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Define logical phase, but do not enter it.</span></div>
<div class="line">    <span class="keyword">auto</span> p2 = <a class="code" href="classbactria_1_1metrics_1_1Phase.html">Phase</a>{<span class="stringliteral">&quot;second_bar_half&quot;</span>};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Once successfully constructed this sector will start collecting metrics right away.</span></div>
<div class="line">    <span class="keyword">auto</span> s1 = <a class="code" href="classbactria_1_1metrics_1_1Sector.html">Sector&lt;Function&gt;</a>{<span class="stringliteral">&quot;bar&quot;</span>, __FILE__, __LINE__, __func__};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Non-entering constructor: This sector needs to be entered manually at a later point. It will not collect any</span></div>
<div class="line">    <span class="comment">// metrics right away.</span></div>
<div class="line">    <span class="keyword">auto</span> s2 = <a class="code" href="classbactria_1_1metrics_1_1Sector.html">Sector&lt;Loop&gt;</a>{<span class="stringliteral">&quot;some_sector&quot;</span>};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Do some work</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="comment">// s2.enter(__FILE__, __LINE__, __func__); // &lt;-- This is very verbose. Fortunately there is a convenience macro:</span></div>
<div class="line">    <a class="code" href="group__bactria__metrics__user.html#gaee715fd22f50c91eaf557d55eca3d52b">bactria_Enter</a>(s2);</div>
<div class="line">    <span class="keywordflow">for</span>(<span class="keyword">auto</span> i = 0; i &lt; 20; ++i)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* ... */</span></div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// s2.leave(__FILE__, __LINE__, __func__); // &lt;-- Same as above</span></div>
<div class="line">    <a class="code" href="group__bactria__metrics__user.html#ga8439a579db9ec004b9d81610e64db2ac">bactria_Leave</a>(s2);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Wrong order! Wrongly nested.</span></div>
<div class="line"><span class="comment">    bactria_Enter(p2);</span></div>
<div class="line"><span class="comment">    bactria_Leave(p1);</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Right order: Leave first phase and enter second phase</span></div>
<div class="line">    <a class="code" href="group__bactria__metrics__user.html#ga8439a579db9ec004b9d81610e64db2ac">bactria_Leave</a>(p1);</div>
<div class="line">    <a class="code" href="group__bactria__metrics__user.html#gaee715fd22f50c91eaf557d55eca3d52b">bactria_Enter</a>(p2);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Collect metrics for every iteration of a loop body</span></div>
<div class="line">    <span class="keyword">auto</span> s3 = <a class="code" href="classbactria_1_1metrics_1_1Sector.html">Sector&lt;Body&gt;</a>{<span class="stringliteral">&quot;loop_body&quot;</span>};</div>
<div class="line">    <span class="keywordflow">for</span>(<span class="keyword">auto</span> i = 0; i &lt; 20; ++i)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group__bactria__metrics__user.html#gaee715fd22f50c91eaf557d55eca3d52b">bactria_Enter</a>(s3);</div>
<div class="line">        <span class="comment">/* Do work */</span></div>
<div class="line">        <a class="code" href="group__bactria__metrics__user.html#ga8439a579db9ec004b9d81610e64db2ac">bactria_Leave</a>(s3);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// End of scope: p2 is left automatically</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="usage_reports"></a>
Reports</h2>
<p>Sometimes the metrics collected by the various vendor-specific plugins are not enough. For this case bactria provides the <code>reports</code> API which enables you to save key-value pairs (where <code>key</code> is a <code>std::string</code> and <code>value</code> an arithmetic type or a <code>std::string</code>). To do this, you first create a <code>IncidentRecorder</code> and use it to create <code>Incident</code>s (the key-value pairs). Once your recording is complete you can submit a <code>Report</code> (which matches the output file generated by the plugin):</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> baz()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">using namespace </span>bactria::reports;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">using</span> clock = std::high_resolution_clock;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Define all types which are stored between recording steps. The last type must be an Incident</span></div>
<div class="line">    <span class="keyword">using</span> Recorder = <a class="code" href="classbactria_1_1reports_1_1IncidentRecorder.html">bactria::reports::IncidentRecorder</a>&lt;</div>
<div class="line">        <span class="keyword">typename</span> clock::time_point,</div>
<div class="line">        <span class="keyword">typename</span> std::chrono::nanoseconds::rep,</div>
<div class="line">        <a class="code" href="classbactria_1_1reports_1_1Incident.html">bactria::reports::Incident&lt;double&gt;</a>,</div>
<div class="line">        <a class="code" href="classbactria_1_1reports_1_1Incident.html">bactria::reports::Incident&lt;int&gt;</a>,</div>
<div class="line">        <a class="code" href="classbactria_1_1reports_1_1Incident.html">bactria::reports::Incident&lt;int&gt;</a>&gt;;</div>
<div class="line">    <span class="keyword">auto</span> ir = Recorder{};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Extract record type from recorder. Our functors can use this to access the recorded values.</span></div>
<div class="line">    <span class="keyword">using</span> Record = <span class="keyword">typename</span> Recorder::record_t;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span>(<span class="keyword">auto</span> i = 0; i &lt; 20; ++i)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Start timer</span></div>
<div class="line">        ir.record_step([](Record&amp; r) {</div>
<div class="line">            <span class="comment">// Store the clock::time_point in the recorder. The index corresponds to the element order defined</span></div>
<div class="line">            <span class="comment">// in the using Recorder = ... directive above.</span></div>
<div class="line">            r.store&lt;0&gt;(clock::now());</div>
<div class="line">        });</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Stop timer</span></div>
<div class="line">        ir.record_step([](Record&amp; r) {</div>
<div class="line">            <span class="comment">// Load the clock::time_point from the recorder.</span></div>
<div class="line">            <span class="keyword">auto</span> <span class="keyword">const</span> start = r.load&lt;0&gt;();</div>
<div class="line">            <span class="keyword">auto</span> <span class="keyword">const</span> end = clock::now();</div>
<div class="line">            <span class="keyword">auto</span> <span class="keyword">const</span> dur = std::chrono::duration_cast&lt;std::chrono::nanoseconds&gt;(end - start);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Store the nanoseconds</span></div>
<div class="line">            r.store&lt;1&gt;(dur.count());</div>
<div class="line">        });</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Do something else with no storage requirements</span></div>
<div class="line">        ir.record_step([]() { std::cout &lt;&lt; <span class="stringliteral">&quot;Something else...&quot;</span> &lt;&lt; std::endl; });</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Calculate average</span></div>
<div class="line">        ir.record_step([&amp;](Record&amp; r) {</div>
<div class="line">            <span class="comment">// Load the nanoseconds</span></div>
<div class="line">            <span class="keyword">auto</span> <span class="keyword">const</span> dur = r.load&lt;1&gt;();</div>
<div class="line">            avgLoopTime += dur;</div>
<div class="line"> </div>
<div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;Hello, Incident!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span>(i &gt; 2 &amp;&amp; (i + 1) % 5 == 0)</div>
<div class="line">            {</div>
<div class="line">                <span class="keyword">auto</span> <span class="keyword">const</span> avg = avgLoopTime / 5.0;</div>
<div class="line">                avgLoopTime = 0.0;</div>
<div class="line"> </div>
<div class="line">                <span class="comment">// Save three different incidents we are interested in</span></div>
<div class="line">                r.store&lt;2&gt;(<a class="code" href="group__bactria__reports__user.html#ga44e5c976783b7dc15480bff5e5721d30">bactria::reports::make_incident</a>(<span class="stringliteral">&quot;Average&quot;</span>, avg));</div>
<div class="line">                r.store&lt;3&gt;(<a class="code" href="group__bactria__reports__user.html#ga44e5c976783b7dc15480bff5e5721d30">bactria::reports::make_incident</a>(<span class="stringliteral">&quot;Step begin&quot;</span>, i - 5 + 1));</div>
<div class="line">                r.store&lt;4&gt;(<a class="code" href="group__bactria__reports__user.html#ga44e5c976783b7dc15480bff5e5721d30">bactria::reports::make_incident</a>(<span class="stringliteral">&quot;Step end&quot;</span>, i + 1));</div>
<div class="line"> </div>
<div class="line">                <span class="comment">// Generate a report. The string (without any extensions) may be used to generate a filename</span></div>
<div class="line">                <span class="comment">// Make sure you include all incident indices you are interested in.</span></div>
<div class="line">                <span class="comment">// Repeated calls to this function with the same name string will append to the already</span></div>
<div class="line">                <span class="comment">// existing file (if any).</span></div>
<div class="line">                r.submit_report&lt;2, 3, 4&gt;(<span class="stringliteral">&quot;loop_average&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        });</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="contrib"></a>
Contributors</h1>
<h2><a class="anchor" id="contrib_core"></a>
Maintainers and Core Developers</h2>
<ul>
<li>Jan Stephan (original author)</li>
</ul>
<h2><a class="anchor" id="contrib_thanks"></a>
Former Members, Contributions and Thanks</h2>
<ul>
<li>Dr. Michael Bussmann</li>
<li>René Widera</li>
</ul>
<h1><a class="anchor" id="ack"></a>
Acknowledgements</h1>
<p>This work was partially funded by the <a href="https://www.casus.science">Center of Advanced Systems Understanding (CASUS)</a> which is financed by <a href="https://www.bmbf.de/en/index.html">Germany's Federal Ministry of Education and Research (BMBF)</a> and by the <a href="https://www.smwk.sachsen.de">Saxon Ministry for Science, Culture and Tourism (SMWK)</a> with tax funds on the basis of the budget approved by the <a href="https://www.landtag.sachsen.de/en/">Saxon State Parliament</a>.</p>
<h1><a class="anchor" id="licence"></a>
Licence</h1>
<p>This free software is licensed unter the EUPL v1.2. Please refer to the <code>LICENSE</code> file in the top-level source code directory for the concrete details of this licence. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="agroup__html_html_gaa43eae6ee7b94c6e890ace8891f4de71"><div class="ttname"><a href="group__html.html#gaa43eae6ee7b94c6e890ace8891f4de71">bactria::ranges::color::blue</a></div><div class="ttdeci">constexpr auto blue</div><div class="ttdef"><b>Definition:</b> Colors.hpp:811</div></div>
<div class="ttc" id="agroup__html_html_gab5e46d92ed8fa06232f8067e60d72003"><div class="ttname"><a href="group__html.html#gab5e46d92ed8fa06232f8067e60d72003">bactria::ranges::color::orange</a></div><div class="ttdeci">constexpr auto orange</div><div class="ttdef"><b>Definition:</b> Colors.hpp:997</div></div>
<div class="ttc" id="aclassbactria_1_1reports_1_1IncidentRecorder_html"><div class="ttname"><a href="classbactria_1_1reports_1_1IncidentRecorder.html">bactria::reports::IncidentRecorder</a></div><div class="ttdoc">Class for dynamic recording of Incidents.</div><div class="ttdef"><b>Definition:</b> IncidentRecorder.hpp:49</div></div>
<div class="ttc" id="agroup__bactria__ranges__user_html_ga092736a1459bddd49cc114adbd3dd681"><div class="ttname"><a href="group__bactria__ranges__user.html#ga092736a1459bddd49cc114adbd3dd681">bactria_Event</a></div><div class="ttdeci">#define bactria_Event(name, color, category)</div><div class="ttdoc">A macro that fires an event.</div><div class="ttdef"><b>Definition:</b> Event.hpp:207</div></div>
<div class="ttc" id="aclassbactria_1_1ranges_1_1Category_html"><div class="ttname"><a href="classbactria_1_1ranges_1_1Category.html">bactria::ranges::Category</a></div><div class="ttdoc">Defines a category.</div><div class="ttdef"><b>Definition:</b> Category.hpp:39</div></div>
<div class="ttc" id="aclassbactria_1_1ranges_1_1Event_html"><div class="ttname"><a href="classbactria_1_1ranges_1_1Event.html">bactria::ranges::Event</a></div><div class="ttdoc">The event class.</div><div class="ttdef"><b>Definition:</b> Event.hpp:48</div></div>
<div class="ttc" id="agroup__html_html_ga91c107cb4a7dd766d7c8d8e823253c71"><div class="ttname"><a href="group__html.html#ga91c107cb4a7dd766d7c8d8e823253c71">bactria::ranges::color::cyan</a></div><div class="ttdeci">constexpr auto cyan</div><div class="ttdef"><b>Definition:</b> Colors.hpp:829</div></div>
<div class="ttc" id="aclassbactria_1_1ranges_1_1Range_html"><div class="ttname"><a href="classbactria_1_1ranges_1_1Range.html">bactria::ranges::Range</a></div><div class="ttdoc">The range class.</div><div class="ttdef"><b>Definition:</b> Range.hpp:52</div></div>
<div class="ttc" id="aclassbactria_1_1metrics_1_1Phase_html"><div class="ttname"><a href="classbactria_1_1metrics_1_1Phase.html">bactria::metrics::Phase</a></div><div class="ttdoc">The phase class.</div><div class="ttdef"><b>Definition:</b> Phase.hpp:42</div></div>
<div class="ttc" id="aclassbactria_1_1metrics_1_1Sector_html"><div class="ttname"><a href="classbactria_1_1metrics_1_1Sector.html">bactria::metrics::Sector</a></div><div class="ttdoc">The sector class.</div><div class="ttdef"><b>Definition:</b> Sector.hpp:54</div></div>
<div class="ttc" id="agroup__bactria__metrics__user_html_ga8439a579db9ec004b9d81610e64db2ac"><div class="ttname"><a href="group__bactria__metrics__user.html#ga8439a579db9ec004b9d81610e64db2ac">bactria_Leave</a></div><div class="ttdeci">#define bactria_Leave(sec)</div><div class="ttdoc">Leave a phase or sector.</div><div class="ttdef"><b>Definition:</b> Sector.hpp:324</div></div>
<div class="ttc" id="agroup__bactria__metrics__user_html_gaee715fd22f50c91eaf557d55eca3d52b"><div class="ttname"><a href="group__bactria__metrics__user.html#gaee715fd22f50c91eaf557d55eca3d52b">bactria_Enter</a></div><div class="ttdeci">#define bactria_Enter(sec)</div><div class="ttdoc">Enter a phase or sector.</div><div class="ttdef"><b>Definition:</b> Sector.hpp:312</div></div>
<div class="ttc" id="agroup__bactria__reports__user_html_ga44e5c976783b7dc15480bff5e5721d30"><div class="ttname"><a href="group__bactria__reports__user.html#ga44e5c976783b7dc15480bff5e5721d30">bactria::reports::make_incident</a></div><div class="ttdeci">auto make_incident(std::string key, TValue value) -&gt; Incident&lt; std::remove_reference_t&lt; TValue &gt;&gt;</div><div class="ttdoc">Create an incident from a key and a value.</div><div class="ttdef"><b>Definition:</b> Incident.hpp:153</div></div>
<div class="ttc" id="aclassbactria_1_1reports_1_1Incident_html"><div class="ttname"><a href="classbactria_1_1reports_1_1Incident.html">bactria::reports::Incident</a></div><div class="ttdoc">The incident type.</div><div class="ttdef"><b>Definition:</b> Incident.hpp:47</div></div>
<div class="ttc" id="agroup__html_html_ga5075e3f73e853ecadcfef98933ff22bf"><div class="ttname"><a href="group__html.html#ga5075e3f73e853ecadcfef98933ff22bf">bactria::ranges::color::red</a></div><div class="ttdeci">constexpr auto red</div><div class="ttdef"><b>Definition:</b> Colors.hpp:1015</div></div>
<div class="ttc" id="abactria_8hpp_html"><div class="ttname"><a href="bactria_8hpp.html">bactria.hpp</a></div><div class="ttdoc">Main include file. Users must (only) include this file.</div></div>
<div class="ttc" id="aclassbactria_1_1Context_html"><div class="ttname"><a href="classbactria_1_1Context.html">bactria::Context</a></div><div class="ttdoc">The context.</div><div class="ttdef"><b>Definition:</b> Context.hpp:50</div></div>
<div class="ttc" id="agroup__html_html_ga22ed4c4d205edff1c2d884569e256d50"><div class="ttname"><a href="group__html.html#ga22ed4c4d205edff1c2d884569e256d50">bactria::ranges::color::green</a></div><div class="ttdeci">constexpr auto green</div><div class="ttdef"><b>Definition:</b> Colors.hpp:907</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
